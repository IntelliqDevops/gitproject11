trigger:
- master

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

stages:
- stage: Download
  displayName: Download
  jobs:
  - job: Download
    displayName: Download
    pool:
      name: "vmagent"
    steps:
    This code is generated by the tool with settings help
    - task: Bash@3
      inputs:
       targetType: 'inline'
       script: 'git clone https://github.com/intelliqittrainings/maven.git'

- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: "vmagent"
    steps:
    - task: Bash@3
      inputs:
       targetType: 'inline'
       script: 'cd /home/azureuser/myagent/_work/2/s/maven;mvn package;cp /home/azureuser/myagent/_work/2/s/webapp/target/webapp.war /home/azureuser'
- stage: CreateDocker
  displayName: CreateDocker
  jobs:
  - job: CreateDocker
    displayName: CreateDocker
    pool:
      name: "vmagent"
    steps:
    - task: Bash@3
      inputs:
       targetType: 'inline'
       script: |
         echo 'FROM tomee' > dockerfile
         echo 'COPY /home/azureuser/webapp.war /usr/local/tomee/webapps/myapp.war' >> dockerfile
    - task: Bash@3
      inputs:
       targetType: 'inline'
       script: 'cp /home/azureuser/myagent/_work/2/s/dockerfile /home/azureuser'

- stage: Upload
  displayName: Build and push stage
  jobs:
  - job: Upload
    displayName: Upload
    pool:
      name: "vmagent"
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)'
        command: 'buildAndPush'
        Dockerfile: '/home/azure/dockerfile'
        buildContext: '/home/azureuser'
        tags: '$(tag)'